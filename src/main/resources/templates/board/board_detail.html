<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/default_layout">
<th:block layout:fragment="content">

    <style>
        /* Add this CSS to style the comment cards */

        .card {
            border: 1px solid #ccc; /* Add a border to the comment card */
            margin-bottom: 20px;
            padding: 10px;
        }

        .comment-header {
            background-color: #f0f0f0; /* Gray background for the writer's name */
            padding: 10px;
        }

        .comment-content {
            background-color: #ffffff; /* White background for the comment content */
            padding: 10px;
            border: 1px solid #ccc; /* Add a border to the comment content */
        }

        .writer-box p {
            margin: 0; /* Remove default margin for writer's name */
        }

        .comment-box p {
            margin: 0; /* Remove default margin for comment content */
        }

        .button-container {
            text-align: right; /* Align buttons to the right */
            margin-top: 10px; /* Add some spacing between content and buttons */
        }

        .btn-sm {
            padding: 5px 10px; /* Adjust button padding for smaller size */
            border: none; /* Remove the border from the buttons */
        }
    </style>


    <main>
        <div class="sb-nav-fixed">
            <div class="container-fluid px-4">
                <h1 class="mt-4">Board</h1>

                <!-- 게시글 상세 정보를 표시할 카드 -->
                <div class="card mb-4">


                    <div class="card-header">

                        <a class="btn btn-primary float-end" th:href="@{/board(page=${p})}">
                            <i class="fas fa-edit"></i> 글 목록
                        </a>

                        <th:block th:if="${m.getEmail().equals(b.getWriterId())}">
                            <a class="btn btn-primary float-end" style="margin-right : 10px;" onclick="deleteBoard()">

                                <i class="fas fa-edit"></i> 글 삭제
                            </a>

                            <a class="btn btn-primary float-end" style="margin-right : 10px;"
                               th:href="@{/board/{id}/update(id=${b.getId})}">
                                <i class="fas fa-edit"></i> 글 수정
                            </a>

                        </th:block>


                    </div>

                    <div class="card-body">
                        <h2 th:text="${b.title}"></h2>
                        <p>작성자: <span th:text="${b.writer}"></span></p>
                        <p>조회수: <span th:text="${b.viewCnt}"></span></p>
                        <p>내용: <span th:text="${b.content}"></span></p>
                    </div>
                </div>

                <!-- 댓글 표시 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>댓글</h3>
                    </div>
                    <div class="card-body">
                        <!-- 댓글 리스트를 표시하는 부분 -->
                        <div class="card-body">
                            <!-- 댓글 리스트를 표시하는 부분 -->
                            <div id="comment-container">
                                <th:block th:if="${commentList.size != 0}" th:each="c : ${commentList}">
                                    <div class="card mb-4">
                                        <div class="comment-header">
                                            <!-- Display writer's name in a gray box -->
                                            <div class="writer-box">
                                                <p><span th:text="${c.writer}"></span>
                                                    <i class="fas fa-user"></i>
                                                </p>

                                            </div>
                                        </div>
                                        <div class="comment-content">
                                            <!-- Display comment content in a white box with a smaller border -->
                                            <div class="comment-box">
                                                <p><span th:text="${c.content}"></span></p>
                                            </div>
                                        </div>
                                        <!-- 수정, 삭제는 댓글 작성한 사람만 가능하다 -->
                                        <th:block th:if="${m.getEmail().equals(c.writerId)}">
                                            <div class="button-container">
                                                <a class="btn btn-sm btn-primary float-right edit-comment-btn"
                                                   th:data-comment-id="${c.id}">
                                                    <i class="fas fa-edit"></i> 수정
                                                </a>
                                                <a class="btn btn-sm btn-primary float-right"
                                                   th:href="@{/board/{id}/comment/{commentId}/delete(id=${b.id})}">
                                                    <i class="fas fa-trash"></i> 삭제
                                                </a>

                                            </div>
                                        </th:block>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>

                    <!-- 댓글 작성 폼 -->
                    <form id="commentForm" method="post" onsubmit="submitComment(event)">
                        <div class="form-group">
                                <textarea class="form-control" name="content" placeholder="댓글을 입력하세요."
                                          required></textarea>
                            <input type="hidden" name="writer" th:value="${m.getName()}">
                            <input type="hidden" name="writerId" th:value="${m.getEmail()}">
                        </div>
                        <button type="submit" style="margin-top : 10px;" class="btn btn-primary">댓글 작성</button>
                    </form>
                </div>
            </div>
        </div>
        </div>
    </main>
    </body>

    <script th:inline="javascript">
        /*<![CDATA[*/
        function deleteBoard() {
            if (confirm("정말 삭제하시겠습니까?")) {
                const id = /*[[${b.id}]]*/;

                fetch('/board/' + id + '/delete', {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            alert("삭제 완료");
                            location.href = "/board";
                        } else {
                            console.error("삭제 실패");
                        }
                    })
                    .catch(error => {
                        console.error("요청 오류:", error);
                    });
            }
        }

        function submitComment(event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(document.getElementById('commentForm'));
            const boardId = /*[[${b.id}]]*/;

            fetch(`/board/${boardId}/comment`, {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    // Get the last comment in the data array
                    const lastComment = data[data.length - 1];

                    const memberEmail = /*[[${m.getEmail()}]]*/;
                    const b = /*[[${b.id}]]*/;

                    const commentContainer = document.getElementById('comment-container');
                    const commentCard = document.createElement('div');
                    commentCard.className = 'card mb-4';
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    cardBody.innerHTML = `
                <p>내용</p>
                <p><span>${lastComment.content}</span></p>
                <p>작성자 ) <span>${lastComment.writer}</span></p>
            `;

                    if (memberEmail === lastComment.writerId) {
                        const deleteButton = document.createElement('a');
                        deleteButton.className = 'btn btn-primary float-end';
                        deleteButton.style.marginRight = '10px';
                        deleteButton.href = `/board/${boardId}/comment/${lastComment.id}/delete`;
                        deleteButton.innerHTML = '<i class="fas fa-edit"></i> 삭제';

                        const updateButton = document.createElement('a');
                        updateButton.className = 'btn btn-primary float-end edit-comment-btn';
                        updateButton.style.marginRight = '10px';
                        updateButton.setAttribute('th:data-comment-id', lastComment.id);
                        updateButton.innerHTML = '<i class="fas fa-edit"></i> 수정';

                        cardBody.appendChild(deleteButton);
                        cardBody.appendChild(updateButton);
                    }

                    commentCard.appendChild(cardBody);
                    commentContainer.appendChild(commentCard);
                })
        }


        $(document).ready(function () {
            // Event delegation to handle edit-comment-btn click events

            $('#comment-container').on('click', '.edit-comment-btn', function () {
                const commentId = $(this).data('comment-id');
                const commentContainer = $(this).closest('.card');
                const commentContent = commentContainer.find('.comment-content p span');
                const boardId = /*[[${b.id}]]*/;
                commentContent.data('original-content', commentContent.text());
                // Create a form element
                const form = document.createElement('form');
                form.method = 'post';
                form.action = `/board/${boardId}/comment/${commentId}/update`;

                // Create a textarea element
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control';
                textarea.name = 'content';
                textarea.required = true;
                textarea.textContent = commentContent.text(); // Set the value of the textarea to the comment content

                // Create a hidden input element for the writer
                const writer = document.createElement('input');
                writer.type = 'hidden';
                writer.name = 'writer';
                writer.value = /*[[${m.getName()}]]*/;

                // Create a cancel button with the icon
                const cancelButton = document.createElement('a');
                cancelButton.className = 'btn btn-sm btn-primary float-right cancel-edit-btn';
                cancelButton.setAttribute('th:data-comment-id', commentId);
                cancelButton.innerHTML = '<i class="fas fa-edit"></i> 취소';

                // Replace the "삭제" button with the "취소" button
                const deleteButton = commentContainer.find('.button-container a:last');
                deleteButton.replaceWith(cancelButton);

                // Append the textarea, hidden input, and "취소" button to the form
                form.appendChild(textarea);
                form.appendChild(writer);

                // Replace the comment content with the form
                commentContent.html(form);

                // Disable the delete button while editing
                deleteButton.addClass('disabled');
            });

                // Event delegation to handle cancel-edit-btn click events
                $('#comment-container').on('click', '.cancel-edit-btn', function () {

                    const commentId = $(this).data('comment-id');
                    const boardId = /*[[${b.id}]]*/;
                    const commentContainer = $(this).closest('.card');
                    const commentContent = commentContainer.find('.comment-content p span');

                    // Check if the comment is being edited
                    if (commentContainer.find('form').length > 0) {
                        // Restore the original comment content
                        const originalContent = commentContent.data('original-content');
                        commentContent.text(originalContent);

                        console.log(originalContent)

                        // Remove the form
                        commentContainer.find('form').remove();

                        // Re-enable the delete button
                        commentContainer.find('.button-container a:last').removeClass('disabled');

                        // Create a delete button with the icon
                        const deleteButton = document.createElement('a');
                        deleteButton.className = 'btn btn-sm btn-primary float-right delete-comment-btn';
                        deleteButton.setAttribute('th:data-comment-id', $(this).data('comment-id'));
                        deleteButton.href = `/board/${boardId}/comment/${commentId}/delete`;
                        deleteButton.innerHTML = '<i class="fas fa-trash"></i> 삭제';

                        // Replace the "취소" button with the "삭제" button
                        $(this).replaceWith(deleteButton);
                    } else {
                        // If the comment is not being edited, it's a regular cancel operation
                        // Create a delete button with the icon
                        const deleteButton = document.createElement('a');
                        deleteButton.className = 'btn btn-sm btn-primary float-right delete-comment-btn';
                        deleteButton.setAttribute('th:data-comment-id', $(this).data('comment-id'));
                        deleteButton.href = `/board/${boardId}/comment/${commentId}/delete`;
                        deleteButton.innerHTML = '<i class="fas fa-trash"></i> 삭제';

                        // Replace the "취소" button with the "삭제" button
                        $(this).replaceWith(deleteButton);
                    }
                });

            // Handle form submission to update the comment
            $('#comment-container').on('submit', 'form', function (event) {
                event.preventDefault(); // Prevent form submission
                const formData = new FormData(this);

                // Send an AJAX request to update the comment
                $.ajax({
                    type: 'POST',
                    url: this.action,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        // Update the comment content in real-time
                        const commentContainer = $(event.target).closest('.card');
                        const commentContent = commentContainer.find('.comment-content p span');
                        commentContent.text(response.content);

                        // Remove the form and reset the "취소" button text to "수정"
                        commentContainer.find('form').remove();

                        // Create an edit button with the icon
                        const editButton = document.createElement('a');
                        editButton.className = 'btn btn-sm btn-primary float-right edit-comment-btn';
                        editButton.setAttribute('th:data-comment-id', $(event.target).find('[name="content"]').data('comment-id'));
                        editButton.innerHTML = '<i class="fas fa-edit"></i> 수정';

                        // Replace the "취소" button with the "수정" button
                        commentContainer.find('.button-container a:last').replaceWith(editButton);

                        // Re-enable the delete button
                        commentContainer.find('.button-container a:last').removeClass('disabled');
                    },
                    error: function () {
                        alert('댓글 수정에 실패하였습니다.');
                    }
                });
            });
        });


    </script>


</th:block>
</html>