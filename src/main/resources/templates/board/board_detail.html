<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/default_layout">
<th:block layout:fragment="content">
    <main>
        <div class="sb-nav-fixed">
            <div class="container-fluid px-4">
                <h1 class="mt-4">Board</h1>

                <!-- 게시글 상세 정보를 표시할 카드 -->
                <div class="card mb-4">


                    <div class="card-header">

                        <a class="btn btn-primary float-end" th:href="@{/board(page=${page})}">
                            <i class="fas fa-edit"></i> 글 목록
                        </a>

                        <th:block th:if="${m.getEmail().equals(b.getWriterId())}">
                            <a class="btn btn-primary float-end" style="margin-right : 10px;" onclick="deleteBoard()">

                                <i class="fas fa-edit"></i> 글 삭제
                            </a>

                            <a class="btn btn-primary float-end" style="margin-right : 10px;"
                               th:href="@{/board/{id}/update(id=${b.getId})}">
                                <i class="fas fa-edit"></i> 글 수정
                            </a>

                        </th:block>


                    </div>

                    <div class="card-body">
                        <h2 th:text="${b.title}"></h2>
                        <p>작성자: <span th:text="${b.writer}"></span></p>
                        <p>조회수: <span th:text="${b.viewCnt}"></span></p>
                        <p>내용: <span th:text="${b.content}"></span></p>
                    </div>
                </div>

                <!-- 댓글 표시 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>댓글</h3>
                    </div>
                    <div class="card-body">
                        <!-- 댓글 리스트를 표시하는 부분 -->
                        <div id="comment-container">
                            <th:block th:if="${commentList.size != 0}"  th:each="c : ${commentList}">
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <p>내용</p>
                                        <p><span th:text="${c.content}"></span></p>
                                        <p>작성자 ) <span th:text="${c.writer}"></span></p>
                                    </div>
                                </div>
                            </th:block>

                            <th:block th:if="${commentList.size == 0}">
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <p>댓글이 없습니다.</p>
                                    </div>
                                </div>
                            </th:block>
                        </div> <!-- 댓글을 표시할 컨테이너 -->
                        <!-- 댓글 작성 폼 -->
                        <form id="commentForm" method="post" onsubmit="submitComment(event)">
                            <div class="form-group">
                                <textarea class="form-control" name="content" placeholder="댓글을 입력하세요." required></textarea>
                                <input type="hidden" name="writer" th:value="${m.getName()}">
                                <input type="hidden" name="writerId" th:value="${m.getEmail()}">
                            </div>
                            <button type="submit" style="margin-top : 10px;" class="btn btn-primary">댓글 작성</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    </body>

    <script th:inline="javascript">
        /*<![CDATA[*/
        function deleteBoard() {
            if (confirm("정말 삭제하시겠습니까?")) {
                const id = /*[[${b.id}]]*/;

                fetch('/board/' + id + '/delete', {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            alert("삭제 완료");
                            location.href = "/board";
                        } else {
                            console.error("삭제 실패");
                        }
                    })
                    .catch(error => {
                        console.error("요청 오류:", error);
                    });
            }
        }

        function submitComment(event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(document.getElementById('commentForm'));
            const boardId = /*[[${b.id}]]*/;

            fetch(`/board/${boardId}/comment`, {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (response.ok) {
                        // Comment was added successfully, so redirect to the current board page
                        window.location.href = '/board/' +  boardId + '?page=' + /*[[${page}]]*/;
                    } else {
                        console.error("Failed to add a comment");
                    }
                })
                .catch(error => {
                    console.error("Request error:", error);
                });
        }

    </script>



</th:block>
</html>