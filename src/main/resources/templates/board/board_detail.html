<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/default_layout">
<th:block layout:fragment="content">

    <style>
        /* Add this CSS to style the comment cards */

        .card {
            border: 1px solid #ccc; /* Add a border to the comment card */
            margin-bottom: 20px;
            padding: 10px;
        }

        .comment-header {
            background-color: #f0f0f0; /* Gray background for the writer's name */
            padding: 10px;
        }

        .comment-content {
            background-color: #ffffff; /* White background for the comment content */
            padding: 10px;
            border: 1px solid #ccc; /* Add a border to the comment content */
        }

        .writer-box p {
            margin: 0; /* Remove default margin for writer's name */
        }

        .comment-box p {
            margin: 0; /* Remove default margin for comment content */
        }

        .button-container {
            text-align: right; /* Align buttons to the right */
            margin-top: 10px; /* Add some spacing between content and buttons */
        }

        .btn-sm {
            padding: 5px 10px; /* Adjust button padding for smaller size */
            border: none; /* Remove the border from the buttons */
        }
    </style>


    <main>
        <div class="sb-nav-fixed">
            <div class="container-fluid px-4">
                <h1 class="mt-4">Board</h1>

                <!-- 게시글 상세 정보를 표시할 카드 -->
                <div class="card mb-4">


                    <div class="card-header">

                        <a class="btn btn-primary float-end" th:href="@{/board(page=${p})}">
                            <i class="fas fa-edit"></i> 글 목록
                        </a>

                        <th:block th:if="${m.getEmail().equals(b.getWriterId())}">
                            <a class="btn btn-primary float-end" style="margin-right : 10px;" onclick="deleteBoard()">

                                <i class="fas fa-edit"></i> 글 삭제
                            </a>

                            <a class="btn btn-primary float-end" style="margin-right : 10px;"
                               th:href="@{/board/{id}/update(id=${b.getId})}">
                                <i class="fas fa-edit"></i> 글 수정
                            </a>

                        </th:block>


                    </div>

                    <div class="card-body">
                        <h2 th:text="${b.title}"></h2>
                        <p>작성자: <span th:text="${b.writer}"></span></p>
                        <p>조회수: <span th:text="${b.viewCnt}"></span></p>
                        <p>내용: <span th:text="${b.content}"></span></p>
                    </div>
                </div>

                <!-- 댓글 표시 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>댓글</h3>
                    </div>
                    <div class="card-body">
                        <!-- 댓글 리스트를 표시하는 부분 -->
                        <div class="card-body">
                            <!-- 댓글 리스트를 표시하는 부분 -->
                            <div id="comment-container">
                                <th:block th:if="${commentList.size != 0}" th:each="c : ${commentList}">
                                    <div class="card mb-4">
                                        <div class="comment-header">
                                            <!-- Display writer's name in a gray box -->
                                            <div class="writer-box">
                                                <p><span th:text="${c.writer}"></span>
                                                    <i class="fas fa-user"></i>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="comment-content">
                                            <!-- Display comment content in a white box with a smaller border -->
                                            <div class="comment-box">
                                                <!-- 수정 모드에서 보일 텍스트 영역 -->
                                                <textarea class="form-control comment-textarea" style="display: none;"></textarea>
                                                <!-- 댓글 내용 -->
                                                <p><span th:text="${c.content}"></span></p>
                                            </div>
                                        </div>
                                        <!-- 수정, 삭제는 댓글 작성한 사람만 가능하다 -->
                                        <th:block th:if="${m.getEmail().equals(c.writerId)}">
                                            <div class="button-container">
                                                <!-- 수정 버튼 -->
                                                <a class="btn btn-sm btn-primary float-right edit-comment-btn"
                                                   th:data-comment-id="${c.id}">
                                                    <i class="fas fa-edit"></i> 수정
                                                </a>
                                                <!-- 삭제 버튼 -->
                                                <a class="btn btn-sm btn-primary float-right delete-comment-btn"
                                                   th:data-comment-id="${c.id}">
                                                    <i class="fas fa-trash"></i> 삭제
                                                </a>
                                                <!-- 저장 버튼 (수정 모드에서만 보이게 함) -->
                                                <a class="btn btn-sm btn-primary float-right save-comment-btn"
                                                   th:data-comment-id="${c.id}" style="display: none;">
                                                    <i class="fas fa-save"></i> 저장
                                                </a>
                                                <!-- 취소 버튼 (수정 모드에서만 보이게 함) -->
                                                <a class="btn btn-sm btn-primary float-right cancel-edit-btn"
                                                   th:data-comment-id="${c.id}" style="display: none;">
                                                    <i class="fas fa-times"></i> 취소
                                                </a>
                                            </div>
                                        </th:block>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>

                    <!-- 댓글 작성 폼 -->
                    <form id="commentForm" method="post" onsubmit="submitComment(event)">
                        <div class="form-group">
                                <textarea class="form-control" name="content" placeholder="댓글을 입력하세요."
                                          required></textarea>
                            <input type="hidden" name="writer" th:value="${m.getName()}">
                            <input type="hidden" name="writerId" th:value="${m.getEmail()}">
                        </div>
                        <button type="submit" style="margin-top : 10px;" class="btn btn-primary">댓글 작성</button>
                    </form>
                </div>
            </div>
        </div>
        </div>
    </main>
    </body>

    <script th:inline="javascript">
        /*<![CDATA[*/
        function deleteBoard() {
            if (confirm("정말 삭제하시겠습니까?")) {
                const id = /*[[${b.id}]]*/;

                fetch('/board/' + id + '/delete', {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            alert("삭제 완료");
                            location.href = "/board";
                        } else {
                            console.error("삭제 실패");
                        }
                    })
                    .catch(error => {
                        console.error("요청 오류:", error);
                    });
            }
        }

        function submitComment(event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(document.getElementById('commentForm'));
            const boardId = /*[[${b.id}]]*/;

            fetch(`/board/${boardId}/comment`, {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    // Get the last comment in the data array
                    const lastComment = data[data.length - 1];
                    const memberEmail = /*[[${m.getEmail()}]]*/;
                    const b = /*[[${b.id}]]*/;

                    const commentContainer = document.getElementById('comment-container');
                    const commentCard = document.createElement('div');
                    commentCard.className = 'card mb-4';
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    cardBody.innerHTML = `
                <p>내용</p>
                <p><span>${lastComment.content}</span></p>
                <p>작성자 ) <span>${lastComment.writer}</span></p>
            `;

                    if (memberEmail === lastComment.writerId) {
                        const deleteButton = document.createElement('a');
                        deleteButton.className = 'btn btn-primary float-end';
                        deleteButton.style.marginRight = '10px';
                        deleteButton.href = `/board/${boardId}/comment/${lastComment.id}/delete`;
                        deleteButton.innerHTML = '<i class="fas fa-edit"></i> 삭제';

                        const updateButton = document.createElement('a');
                        updateButton.className = 'btn btn-primary float-end edit-comment-btn';
                        updateButton.style.marginRight = '10px';
                        updateButton.setAttribute('th:data-comment-id', lastComment.id);
                        updateButton.innerHTML = '<i class="fas fa-edit"></i> 수정';

                        cardBody.appendChild(deleteButton);
                        cardBody.appendChild(updateButton);
                    }

                    commentCard.appendChild(cardBody);
                    commentContainer.appendChild(commentCard);
                })
        }

        // 수정 버튼 클릭 시
        $('.edit-comment-btn').click(function () {
            var commentId = $(this).data('comment-id');
            console.log(commentId);
            // 해당 댓글의 수정 버튼
            var editBtn = $(this);
            // 해당 댓글의 삭제 버튼
            var deleteBtn = editBtn.siblings('.delete-comment-btn');
            // 해당 댓글의 취소 버튼
            var cancelBtn = editBtn.siblings('.cancel-edit-btn');
            // 해당 댓글의 저장 버튼
            var saveBtn = editBtn.siblings('.save-comment-btn');
            // 해당 댓글의 댓글 내용
            var commentContent = editBtn.closest('.comment-content').find('.comment-box p span');
            // 해당 댓글의 텍스트 영역
            var textarea = editBtn.closest('.comment-content').find('.comment-textarea');

            // 현재 댓글 내용을 텍스트 영역에 설정
            textarea.val(commentContent.text());
            // 댓글 내용을 숨기고 텍스트 영역을 보이게 함
            commentContent.hide();
            textarea.show();

            // 수정 버튼을 숨기고
            editBtn.hide();
            // 삭제 버튼을 숨기고
            deleteBtn.hide();
            // 취소 버튼을 보이게 하고
            cancelBtn.show();
            // 저장 버튼을 보이게 함
            saveBtn.show();
        });

        // 취소 버튼 클릭 시
        $('.cancel-edit-btn').click(function () {
            var commentId = $(this).data('comment-id');
            console.log(commentId);
            // 해당 댓글의 취소 버튼
            var cancelBtn = $(this);
            // 해당 댓글의 수정 버튼
            var editBtn = cancelBtn.siblings('.edit-comment-btn');
            // 해당 댓글의 삭제 버튼
            var deleteBtn = cancelBtn.siblings('.delete-comment-btn');
            // 해당 댓글의 저장 버튼
            var saveBtn = cancelBtn.siblings('.save-comment-btn');
            // 해당 댓글의 댓글 내용
            var commentContent = cancelBtn.closest('.comment-content').find('.comment-box p span');
            // 해당 댓글의 텍스트 영역
            var textarea = cancelBtn.closest('.comment-content').find('.comment-textarea');

            // 텍스트 영역을 숨기고
            textarea.hide();
            // 댓글 내용을 보이게 함
            commentContent.show();

            // 취소 버튼을 숨기고
            cancelBtn.hide();
            // 수정 버튼을 보이게 하고
            editBtn.show();
            // 삭제 버튼을 보이게 함
            deleteBtn.show();
            // 저장 버튼을 숨기게 함
            saveBtn.hide();
        });

        // 저장 버튼 클릭 시
        $('.save-comment-btn').click(function () {
            var commentId = $(this).data('comment-id');
            console.log(commentId);
            // 해당 댓글의 저장 버튼
            var saveBtn = $(this);
            // 해당 댓글의 수정 버튼
            var editBtn = saveBtn.siblings('.edit-comment-btn');
            // 해당 댓글의 삭제 버튼
            var deleteBtn = saveBtn.siblings('.delete-comment-btn');
            // 해당 댓글의 취소 버튼
            var cancelBtn = saveBtn.siblings('.cancel-edit-btn');
            // 해당 댓글의 댓글 내용
            var commentContent = saveBtn.closest('.comment-content').find('.comment-box p span');
            // 해당 댓글의 텍스트 영역
            var textarea = saveBtn.closest('.comment-content').find('.comment-textarea');
            // 수정한 댓글 내용
            var editedContent = textarea.val();

            // 수정한 댓글 내용을 화면에 업데이트
            commentContent.text(editedContent);

            // 텍스트 영역을 숨기고
            textarea.hide();
            // 댓글 내용을 보이게 함
            commentContent.show();

            // 저장 버튼을 숨기고
            saveBtn.hide();
            // 수정 버튼을 보이게 하고
            editBtn.show();
            // 삭제 버튼을 보이게 함
            deleteBtn.show();
            // 취소 버튼을 숨기게 함
            cancelBtn.hide();
        });





    </script>


</th:block>
</html>